{% extends "base.html" %}
{% block content %}

<section>
    <div class="top-bar">
        <div class="card-header" style="width: 100%;">Welcome back, {{ user_name }}!
            {% if role == 'admin' %}(Admin){% endif %}
        </div>
        <div class="note">Note: To disable all rules, you must confirm that you have finished
            planned homework, and (<b>MATH</b>, <b>PIANO</b>, and <b>BOOKS</b> are
            mandatory
            every day)</div>
        {% if role == 'admin' %}
        <div class="note font-semibold">
            <form method="get" action="/todo">
                <label for="view_user">View User:</label>
                <select name="view_user" id="view_user" onchange="this.form.submit()">
                    {% for u in users_list %}
                    <option value="{{ u }}" {% if u==selected_user %}selected{% endif %}>{{ u }}</option>
                    {% endfor %}
                </select>
            </form>
        </div>
        {% endif %}
    </div>

    <div class="today-section">
        <div class="card-header">{{ selected_user }}'s To-Do List Today</div>
        {% if today_tasks %}
        <form method="POST" action="/update_todo/{{ selected_user }}" class="task-update-form">
            <table class="table-modern">
                <tr>
                    <th>Time Slot</th>
                    <th>Task</th>
                    <th>Done</th>
                </tr>
                {% for todo_id, time_slot, task, completed in today_tasks %}
                <tr>
                    <td>{{ time_slot }}</td>
                    <td>
                        <input type="hidden" name="todo_id" value="{{ todo_id }}">
                        <input type="text" name="task_{{ todo_id }}" value="{{ task }}"
                            class=" {% if completed %}done{% endif %} text-center bg-orange-500/10 text-[#ff6b00]"
                            style="width: 90%;" />
                    </td>
                    <td>
                        <input type="checkbox" class="complete-checkbox" name="completed_{{ todo_id }}"
                            data-task-id="{{ todo_id }}" {% if completed %}checked{% endif %} />
                    </td>
                </tr>
                {% endfor %}
            </table>
            <div class="note">Note: Maintaining accurate records after completing each
                task.(means:modify)
            </div>
            <div class="btn-area">
                <button class="btn border bg-orange-500/10 text-[#ff6b00]" type="submit"
                    title="Save changes to all tasks">‚òØÔ∏è Modify
                    All</button>
            </div>
        </form>
        {% else %}
        <p class="message">No tasks saved for today.</p>
        {% endif %}

        <div class="card-header">Plan New To-Do List for {{ selected_user }}</div>

        <form method="POST" id="todoForm" class="planner-form">
            <input type="hidden" name="slot_type" value="{{ slot_type }}">
            <input type="hidden" name="is_holiday" value="{{ is_holiday }}">
            <table class="table-modern">
                <tr>
                    <th>Time Slot</th>
                    <th>Task</th>
                    <th class="transparent">--------</th>
                </tr>
                {% for slot in slots %}
                <tr>
                    <td>{{ slot }}</td>
                    <td><input type="text" name="{{ slot }}" class="task-input text-center"
                            placeholder="MainTask[SubProblem]/MainTask[SubProblem]" required style="width: 90%;">
                    </td>
                    <td>--------</td>
                </tr>
                {% endfor %}
            </table>
            <div class="btn-area">
                <button class="btn border bg-orange-500/10 text-[#ff6b00]" type="submit" name="save_todo"
                    title="This will overwrite the previous list.">üèÑüèª
                    Delete Previous
                    and
                    Save
                    New To-Do
                    List</button>
            </div>
        </form>

        <div class="btn-area">
            {% if show_disable_button %}
            <form action="/exec_rules/{{ selected_user_row_id }}"
                onsubmit="return confirm('Are you sure you brush toilet, take out the garbage, and wash the dishes?');"
                method="POST">
                <button class="btn border bg-orange-500/10 text-[#ff6b00]" type="submit"
                    title="Disable all rules after mandatory cleanup">üõë
                    Disable
                    All Rules</button>
            </form>
            {% else %}
            <p class="note" style="background-color: transparent;">Not proper time to disable rules
                (button
                available between 4 PM and 6 PM)</p>
            {% endif %}
        </div>
    </div>

    <div class="longterm-section">
        <div class="pt-[10px]">
            <div class="card-header">Mid-Term & Long-Term Goals Tracking</div>
            <div id="long-term-container" class="flex flex-col gap-6 p-6 rounded-xl shadow-sm">
                <div class="note"> Track tasks more than 3 days to finish. You can drag the
                    list items to sort the long term goals. Finished tasks will automatically dispear after 3 days.
                </div>
                <form id="add-longterm-form" class="flex gap-2">
                    <div class="flex-grow w-3/5">
                        <input type="text" id="longterm-task-text" placeholder="New Target[Problem] Format">
                    </div>
                    <div class="w-1/5">
                        <div class="relative">
                            <select id="longterm-priority">
                                <option value="1">High</option>
                                <option value="2">Medium-High</option>
                                <option value="3" selected>Medium</option>
                                <option value="4">Medium-Low</option>
                                <option value="5">Low</option>
                            </select>
                            <div
                                class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                                <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg"
                                    viewBox="0 0 20 20">
                                    <path
                                        d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z" />
                                </svg>
                            </div>
                        </div>
                    </div>
                    <button type="submit"
                        class="w-1/5 h-10 px-6 bg-[#172a45] hover:bg-purple-500/10 text-purple-300 uppercase font-small rounded-lg shadow-md hover:shadow-lg transition-all flex items-center justify-center gap-2 whitespace-nowrap">
                        <span>üèÜ</span>
                        <span>Add Task</span>
                    </button>
                </form>
                <div class="grid grid-cols-41 text-sm font-bold border-b">
                    <div class="col-span-1 text-left">
                        <span class="help-btn">‚òëÔ∏è</span>
                        <div class="help-popup hidden">
                            <p>Complete? <br><b>You can toggle the multi select input to finish the task.</b></p>
                        </div>
                    </div>
                    <div class="col-span-23 text-center uppercase flex-grow">Task Name</div>
                    <div class="col-span-17 flex justify-between items-center text-center uppercase">
                        <span class="w-1/3 ">Due</span>
                        <span class="w-1/3 min-w-10">Track</span>
                        <span class="w-1/3 min-w-20 pr-2 ">Actions</span>
                    </div>
                </div>
                <div>
                    <ul id="longterm-list"></ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.getElementById("todoForm").addEventListener("submit", function (e) {
            const inputs = document.querySelectorAll(".task-input");
            const pattern = /^([^\[\]/]+\[[^\[\]]+\])(\s*\/\s*[^\[\]/]+\[[^\[\]]+\])*$/; // matches: main[sub]
            for (const input of inputs) {
                if (input.value.trim() !== "" && !pattern.test(input.value.trim())) {
                    e.preventDefault();
                    alert(`‚ùå Invalid format: "${input.value}". Use "main task[sub task]" format.`);
                    input.focus();
                    return;
                }
            }
        });

        document.querySelectorAll('.complete-checkbox').forEach(cb => {
            cb.addEventListener('change', function () {
                // Here will find data-task-id field in todo HTML
                const taskId = this.dataset.taskId;
                const completed = this.checked;

                fetch("/todo/mark_done", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        id: taskId,
                        completed: completed
                    })
                })
                    .then(async r => {
                        let data = null;

                        // Check if response is JSON
                        const text = await r.text();
                        try {
                            data = JSON.parse(text);
                        } catch (e) {
                            console.error("Server did not return JSON:", text);
                            throw new Error("Invalid JSON response");
                        }
                        return data;
                    })
                    .then(data => {
                        if (data.success) {
                            location.reload();
                        } else {
                            alert("Update failed!");
                        }
                    })
                    .catch(err => {
                        console.error("AJAX error:", err);
                        alert("Error updating task");
                    });
            });
        });

        // -------- below is not for TODO any more, for Long Term Goal -------

        function attachHelperPopups() {
            document.querySelectorAll(".help-btn").forEach(btn => {
                btn.addEventListener("click", (e) => {
                    e.stopPropagation();
                    const popup = btn.nextElementSibling;
                    popup.classList.toggle("hidden");
                });
                btn.addEventListener("mouseenter", () => {
                    btn.nextElementSibling.classList.remove("hidden");
                });
                btn.addEventListener("mouseleave", () => {
                    btn.nextElementSibling.classList.add("hidden");
                });
            });

            document.addEventListener("click", () => {
                document.querySelectorAll(".help-popup").forEach(p => p.classList.add("hidden"));
            });
        }

        new Sortable(document.getElementById("longterm-list"), {
            animation: 150,
            handle: ".drag-handle",
            onEnd: function () {
                saveNewOrder();
                refreshTaskPos();
                refreshTaskColors();
            }
        });

        function saveNewOrder() {
            let ids = [...document.querySelectorAll("#longterm-list li")]
                .map(li => li.dataset.id);

            fetch("/todo/long_term_reorder", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ order: ids })
            });
        }

        const PRIORITY_LABELS = {
            1: "High",
            2: "Medium-High",
            3: "Medium",
            4: "Medium-Low",
            5: "Low"
        };

        /**
         * Map any priority range 1..maxValue into a 1..5 scale.
         * 1 = highest priority
         * 5 = lowest priority
         */
        function mapPriorityToFiveLevels(priority, maxValue) {
            if (maxValue <= 1) return 1;  // only one level

            // Linear mapping to range [1..5]
            const normalized = (priority - 1) / (maxValue - 1); // range 0..1
            const scaled = Math.round(normalized * 4) + 1;      // range 1..5

            return Math.min(5, Math.max(1, scaled)); // clamp safety
        }

        function refreshTaskPos() {
            const items = document.querySelectorAll("#longterm-list li select option[selected]");

            items.forEach((el, index) => {
                const pos = index + 1; // new position

                // Re-apply based on new pos
                el.value = pos;
            });
        }

        function refreshTaskColors() {
            const items = document.querySelectorAll("#longterm-list li input[type='text']");
            color_length = items.length;

            items.forEach((el, index) => {
                const pos = index + 1; // new position

                // Remove previous color classes
                el.classList.remove("priority-1", "priority-2", "priority-3", "priority-4", "priority-5");
                // el.style.background = "#FFFFFF";
                // el.style.color = "#e6ffed";

                // Re-apply based on new pos
                level = mapPriorityToFiveLevels(pos, color_length)
                el.classList.add(`priority-${level}`);
            });
        }

        function renderShortDatePicker(container, pgTimestamp, options = {}, goal_id) {
            options = Object.assign({
                format: 'MMM DDD',
                locale: 'en',
                emptyText: 'DUE'
            }, options);

            const fakeSpan = document.createElement('span');
            fakeSpan.style.cssText = `
                cursor: pointer;
                padding: 6px 12px;
                border-radius: 6px;
                font-size: 14px;
                display: inline-block;
                min-width: 60px;
                text-align: center;
                user-select: none;
            `;

            container.dataset.goal_id = goal_id;

            let currentDate = null;
            if (pgTimestamp) {
                currentDate = new Date(pgTimestamp);
                if (isNaN(currentDate)) currentDate = null;
            }

            function updateDisplay() {
                if (currentDate) {
                    const formatted = new Intl.DateTimeFormat(options.locale === 'en' ? 'en-US' : 'zh-CN', {
                        month: 'short',
                        day: 'numeric'
                    }).format(currentDate);
                    // console.log("formatted data ", formatted)
                    fakeSpan.textContent = options.format
                        .replace('MMM', formatted.split(' ')[0])
                        .replace('DDD', formatted.split(' ')[1] || formatted.split(' ')[0]);
                } else {
                    fakeSpan.textContent = options.emptyText;
                }
                // console.log("fakeSpan ", fakeSpan);
            }
            updateDisplay();

            const fp = flatpickr(fakeSpan, {
                dateFormat: "Y-m-d",
                defaultDate: currentDate,
                locale: options.locale === 'zh' ? "zh" : "default",
                clickOpens: true,
                allowInput: false,
                onChange: function (selectedDates, dateStr) {
                    currentDate = selectedDates[0] || null;
                    updateDisplay();
                    container.dataset.due = currentDate.toISOString().split('T')[0] + 'T12:00:00'

                    if (container.dataset.goal_id) {
                        updateDueDateToServer(container.dataset.goal_id, container.dataset.due);
                    }
                }
            });

            function updateDueDateToServer(goalId, dateStr) {
                fetch(`/todo/longterm_update_due/${goalId}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ due_date: dateStr })
                });
            }

            container.innerHTML = '';
            container.appendChild(fakeSpan);

            return {
                getValue: () => currentDate ? fp.formatDate(currentDate, "Y-m-d") : null,
                setValue: (dateStr) => fp.setDate(dateStr, true)
            };
        }

        async function loadLongTerm() {
            let r = await fetch("/todo/long_term_list/{{ selected_user_row_id }}", {
                headers: { "Authorization": "Bearer " + localStorage.getItem("access_token") }
            });
            let tasks = await r.json();

            let container = document.getElementById("longterm-list");
            container.innerHTML = "";

            color_length = tasks.length;

            tasks.forEach(t => {
                let li = document.createElement("li");

                li.addEventListener("keydown", function (e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        updateLongTerm(t.goal_id, color_length);
                    }
                });

                li.setAttribute("data-id", t.goal_id);

                li.innerHTML = `
                <div class="grid grid-cols-5">
                    <div class="col-span-3 justify-between items-center text-center">
                        <input type="checkbox" ${t.completed ? "checked" : ""} onchange="updateLongTerm(${t.goal_id}, ${color_length})">

                        <input type="text" id="task_${t.goal_id}" value="${t.task}" class="drag-handle ${t.completed ? "done" : ""}
                            text-[#ecf0f1] priority-${mapPriorityToFiveLevels(t.priority, color_length)}"
                            style="width: 95%; margin-bottom: 5px; margin-top: 5px;">

                        <select class="hidden priority-${mapPriorityToFiveLevels(t.priority, color_length)} text-[#ecf0f1]"
                            id="prio_${t.goal_id}" onchange="updateLongTerm(${t.goal_id}, ${color_length})">
                            ${[1, 2, 3, 4, 5].map(p =>
                    `<option value="${t.priority}" ${p == mapPriorityToFiveLevels(t.priority, color_length) ? "selected" : ""}>
                                ${PRIORITY_LABELS[p]}
                            </option>`
                ).join("")}
                        </select>
                    </div>
                    <div class="col-span-2 flex justify-between items-center text-center">
                        <span class="short-date w-1/3" data-due="${t.due_date || ''}"></span>

                        <span class="time-spent w-1/3 min-w-10" id="time-${t.goal_id}">
                            ${formatSeconds(t.time_spent)}
                        </span>

                        <button class="timer-btn w-1/3 min-w-20 ${t.is_tracking ? "stop text-purple-300" : "start text-green-300"}">
                            ${t.is_tracking ? "‚è∏ Pause" : "‚ñ∂ Start"}
                        </button>
                        <div class="menu-container">
                            <button class="menu-btn text-gray-400 hover:text-gray-600 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-ellipsis-vertical w-5 h-5" aria-hidden="true">
                                    <circle cx="12" cy="12" r="1"></circle>
                                    <circle cx="12" cy="5" r="1"></circle>
                                    <circle cx="12" cy="19" r="1"></circle>
                                </svg>
                            </button>
                            <div class="menu-popup hidden">
                                <div class="menu-item delete-item" data-goal-id="${t.goal_id}">
                                    ‚ùå Delete
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                `;

                li.querySelectorAll('.short-date').forEach(el => {
                    renderShortDatePicker(el, el.dataset.due, {
                        format: 'MMM DDD',
                        locale: 'en',
                        emptyText: '-'
                    }, t.goal_id);
                });

                li.querySelectorAll('.timer-btn').forEach(el => {
                    startGoalTracking(el, t.is_tracking, t.goal_id);
                });

                // Toggle popup
                li.querySelectorAll(".menu-btn").forEach(btn => {
                    btn.addEventListener("click", (e) => {
                        e.stopPropagation();
                        const popup = btn.nextElementSibling;
                        popup.classList.toggle("hidden");
                    });
                });

                // Delete item
                li.querySelectorAll(".delete-item").forEach(item => {
                    item.addEventListener("click", handleDeleteGoal);
                });

                // Close popups when clicking outside
                document.addEventListener("click", () => {
                    document.querySelectorAll(".menu-popup").forEach(p => p.classList.add("hidden"));
                });

                container.appendChild(li);
            });
        }

        async function updateLongTerm(goal_id, color_length) {
            let body = {
                goal_id,
                color_length,
                task: document.getElementById("task_" + goal_id).value,
                priority: document.getElementById("prio_" + goal_id).value,
                completed: document.querySelector(`#longterm-list input[type='checkbox'][onchange='updateLongTerm(${goal_id}, ${color_length})']`).checked,
            };

            await fetch("/todo/long_term_update", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + localStorage.getItem("access_token")
                },
                body: JSON.stringify(body)
            });

            loadLongTerm();
        }

        document.getElementById("add-longterm-form").addEventListener("submit", async e => {
            e.preventDefault();
            const pattern = /^([^\[\]/]+\[[^\[\]]+\])(\s*\/\s*[^\[\]/]+\[[^\[\]]+\])*$/; // matches: main[sub]
            input = document.getElementById("longterm-task-text")
            if (input.value.trim() !== "" && !pattern.test(input.value.trim())) {
                alert(`‚ùå Invalid format: "${input.value}". Use "Object[Problem]" format.`);
                input.focus();
                return;
            } else if (input.value.trim() === "") {
                alert(`‚ùå Can't be NULL: "${input.value}". Use "Object[Problem]" format.`);
                input.focus();
                return;
            }

            await fetch("/todo/long_term_add", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + localStorage.getItem("access_token")
                },
                body: JSON.stringify({
                    user_id: "{{ selected_user_row_id }}",
                    task: document.getElementById("longterm-task-text").value,
                    priority: document.getElementById("longterm-priority").value
                })
            });

            document.getElementById("longterm-task-text").value = "";
            loadLongTerm();
        });

        function formatSeconds(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            return `${h}h ${m}m`;
        }

        function startGoalTracking(btn, is_tracking, goal_id) {
            btn.dataset.goal_id = goal_id;
            btn.dataset.is_tracking = String(is_tracking);
            btn.addEventListener("click", () => {
                const isTracking = btn.dataset.is_tracking === "true";
                // console.log("Before:", btn.dataset.is_tracking)
                // update DB
                const url = isTracking
                    ? `/todo/longterm_stop/${goal_id}`
                    : `/todo/longterm_start/${goal_id}`;

                fetch(url, { method: "POST" })
                    .then(r => r.json())
                    .then(data => {
                        // console.log("DB updated", data);
                        if (data.time_spent !== undefined) {
                            const timeSpan = document.querySelector(`#time-${goal_id}`);
                            timeSpan.textContent = formatSeconds(data.time_spent);
                        }
                    });
                // update UI
                btn.dataset.is_tracking = String(!isTracking);
                // console.log("After:", btn.dataset.is_tracking)
                if (btn.dataset.is_tracking === "true") {
                    btn.classList.remove("start");
                    btn.classList.remove("text-green-300");
                    btn.classList.add("stop");
                    btn.classList.add("text-purple-300");
                    btn.innerText = "‚è∏ Pause";
                } else {
                    btn.classList.remove("stop");
                    btn.classList.remove("text-purple-300");
                    btn.classList.add("start");
                    btn.classList.add("text-green-300");
                    btn.innerText = "‚ñ∂ Start";
                }
            });
        }

        function handleDeleteGoal(e) {
            const goalId = e.target.dataset.goalId;

            fetch(`/todo/longterm_delete/${goalId}`, { method: "POST" })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        const li = document.querySelector(`li[data-id="${goalId}"]`);
                        if (li) li.remove();
                    }
                })
                .catch(err => console.error("Delete error:", err));
        }

        loadLongTerm();
        attachHelperPopups();

    </script>

    <div class="card-header">Configuration</div>
    <form method="POST">
        <label for="slot_type">Time Slot Length:</label>
        <select name="slot_type" id="slot_type" onchange="this.form.submit()">
            <option value="30" {% if slot_type=='30' %}selected{% endif %}>30 minutes</option>
            <option value="60" {% if slot_type=='60' %}selected{% endif %}>1 hour</option>
        </select>
    </form>
    <form method="POST">
        <label for="is_holiday">Is today a Holiday/School Break/Non-Instructional Day?</label>
        <select class="btn-area" name="is_holiday" id="is_holiday" onchange="this.form.submit()">
            <option value="off" {% if is_holiday=='off' %}selected{% endif %}>OFF</option>
            <option value="on" {% if is_holiday=='on' %}selected{% endif %}>ON</option>
        </select>
    </form>

</section>
{% endblock %}