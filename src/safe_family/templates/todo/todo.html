{% extends "base.html" %}
{% block content %}

<section>
    <div class="top-bar">
        <div class="card-header" style="width: 100%;">Welcome back, {{ user_name }}!
            {% if role == 'admin' %}(Admin){% endif %}
        </div>
        <div class="note">Note: To disable all rules, you must confirm that you have finished
            planned homework, and (<b>MATH</b>, <b>PIANO</b>, and <b>BOOKS</b> are
            mandatory
            every day)</div>
        {% if role == 'admin' %}
        <div class="note font-semibold">
            <form method="get" action="/todo">
                <label for="view_user">View User:</label>
                <select name="view_user" id="view_user" onchange="this.form.submit()">
                    {% for u in users_list %}
                    <option value="{{ u }}" {% if u==selected_user %}selected{% endif %}>{{ u }}</option>
                    {% endfor %}
                </select>
            </form>
        </div>
        {% endif %}
    </div>

    <div class="today-section">
        <div class="card-header">{{ selected_user }}'s To-Do List Today</div>
        {% if today_tasks %}
        <form method="POST" action="/update_todo/{{ selected_user }}" class="task-update-form">
            <table class="table-modern">
                <tr>
                    <th>Time Slot</th>
                    <th>
                        Task
                        <button type="button" class="notify-current-task-btn btn border bg-orange-500/10 text-[#ff6b00]"
                            title="Send current task to Hammerspoon"
                            style="margin-left: 8px; padding: 2px 6px; font-size: 0.75rem;">
                            Notify Current
                        </button>
                    </th>
                    <th>Completed</th>
                </tr>
                {% for todo_id, time_slot, task, completed, completion_status in today_tasks %}
                <tr class="todo-row" data-todo-id="{{ todo_id }}" data-time-slot="{{ time_slot }}"
                    data-task="{{ task }}" data-completed="{{ 'true' if completed else 'false' }}"
                    data-status="{{ completion_status }}">
                    <td class="time-slot-cell" data-time-slot="{{ time_slot }}"
                        style="--slot-progress: {{ (loop.index0 / (today_tasks|length - 1)) if today_tasks|length > 1 else 0 }}; --slot-fill: 0%;">
                        {{ time_slot }}
                    </td>
                    <td class="task-cell">
                        <input type="hidden" name="todo_id" value="{{ todo_id }}">
                        <input type="text" name="task_{{ todo_id }}" value="{{ task }}"
                            class=" {% if completed %}done{% endif %} text-center bg-orange-500/10 text-[#ff6b00]"
                            style="width: 90%;" />
                        <button type="button" class="split-slot-btn" data-todo-id="{{ todo_id }}"
                            aria-label="Split this slot into 30 minute blocks">+</button>
                    </td>
                    <td>
                        <input type="checkbox" class="complete-checkbox" name="completed_{{ todo_id }}"
                            data-task-id="{{ todo_id }}" {% if completed %}checked{% endif %} />
                        {% if role == 'admin' and selected_user != user_name %}
                        <select class="admin-status-select" data-todo-id="{{ todo_id }}">
                            <option value="" {% if completion_status=='' %}selected{% endif %}></option>
                            <option value="skipped" {% if completion_status=='skipped' %}selected{% endif %}>Skipped
                            </option>
                            <option value="partially done" {% if completion_status=='partially done' %}selected{% endif
                                %}>
                                Partially Done
                            </option>
                            <option value="half done" {% if completion_status=='half done' %}selected{% endif %}>
                                Half Done
                            </option>
                            <option value="mostly done" {% if completion_status=='mostly done' %}selected{% endif %}>
                                Mostly Done
                            </option>
                            <option value="done" {% if completion_status=='done' %}selected{% endif %}>Done</option>
                        </select>
                        {% else %}
                        <div class="task-status" data-status="{{ completion_status }}">
                            {{ completion_status }}
                        </div>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </table>
            <div class="note">Note: Maintaining accurate records after completing each
                task.(means:modify)
            </div>
            <div class="btn-area">
                <button class="btn border bg-orange-500/10 text-[#ff6b00]" type="submit"
                    title="Save changes to all tasks">‚òØÔ∏è Modify
                    All</button>
            </div>
        </form>
        <div class="btn-area">
            <form action="/rules_toggle/disable_ai"
                onsubmit="return confirm('Are you sure you have made good plan today?');" method="POST">
                <button class="btn border bg-orange-500/10 text-[#ff6b00]" type="submit" title="Open AI">ü§ñ
                    Open AI
                </button>
            </form>
        </div>
        {% else %}
        <p class="message">No tasks saved for today, results in no *AI* websites enabled.</p>
        {% endif %}

        <div class="card-header">Plan New To-Do List for {{ selected_user }}</div>

        <form method="POST" id="todoForm" class="planner-form">
            <input type="hidden" name="slot_type" value="{{ slot_type }}">
            <input type="hidden" name="schedule_mode" value="{{ schedule_mode }}">
            <input type="hidden" name="custom_start" value="{{ custom_start }}">
            <input type="hidden" name="custom_end" value="{{ custom_end }}">
            <table class="table-modern">
                <tr>
                    <th>Time Slot</th>
                    <th>Task</th>
                    <th class="transparent">--------</th>
                </tr>
                {% for slot in slots %}
                <tr>
                    <td>{{ slot }}</td>
                    <td><input type="text" name="{{ slot }}" class="task-input text-center"
                            placeholder="MainTask[SubProblem]" required style="width: 90%;">
                    </td>
                    <td>--------</td>
                </tr>
                {% endfor %}
            </table>
            <div class="btn-area">
                <button class="btn border bg-orange-500/10 text-[#ff6b00]" type="submit" name="save_todo"
                    title="This will overwrite the previous list.">üèÑüèª
                    Delete Previous
                    and
                    Save
                    New To-Do
                    List</button>
            </div>
        </form>

        <div class="btn-area">
            {% if show_disable_button %}
            <form action="/exec_rules/{{ selected_user_row_id }}"
                onsubmit="return confirm('Are you sure you brush toilet, take out the garbage, and wash the dishes?');"
                method="POST">
                <button class="btn border bg-orange-500/10 text-[#ff6b00]" type="submit"
                    title="Disable all rules after mandatory cleanup">üõë
                    Disable
                    All Rules</button>
            </form>
            {% else %}
            <p class="note" style="background-color: transparent;">Not proper time to disable rules
                (button
                available between 4 PM and 6 PM)</p>
            {% endif %}
        </div>
    </div>

    {% if show_task_feedback %}
    <div id="task-feedback-modal" class="task-feedback-modal" aria-hidden="true">
        <div class="task-feedback-panel">
            <div class="task-feedback-title">How did this task go?</div>
            <div class="task-feedback-meta">
                <span class="task-feedback-time"></span>
                <span class="task-feedback-name"></span>
            </div>
            <div class="task-feedback-actions">
                <button type="button" class="feedback-option" data-status="skipped">Skipped</button>
                <button type="button" class="feedback-option" data-status="partially done">Partially Done</button>
                <button type="button" class="feedback-option" data-status="half done">Half Done</button>
                <button type="button" class="feedback-option" data-status="mostly done">Mostly Done</button>
                <button type="button" class="feedback-option" data-status="done">Done</button>
            </div>
            <button type="button" class="feedback-later" data-action="later">‚û°Ô∏èPlan Something Else, Check Later</button>
        </div>
    </div>
    {% endif %}

    <div id="weekly-summary-modal" class="weekly-summary-modal" aria-hidden="true">
        <div class="weekly-summary-panel">
            <div class="weekly-summary-header">
                <div class="weekly-summary-title">Weekly Summary</div>
                <button type="button" class="weekly-summary-close" aria-label="Close weekly summary">‚úï</button>
            </div>
            <div class="weekly-summary-subtitle">Loading summary...</div>
            <pre class="weekly-summary-content"></pre>
            <button type="button" class="weekly-summary-close-btn">Close</button>
        </div>
    </div>

    <div id="unknown-tags-modal" class="unknown-tags-modal" aria-hidden="true">
        <div class="unknown-tags-panel">
            <div class="unknown-tags-header">
                <div class="unknown-tags-title">Update Unknown Tags</div>
                <button type="button" class="unknown-tags-close" aria-label="Close tag update">‚úï</button>
            </div>
            <div class="unknown-tags-subtitle">Fill in tags before planning today.</div>
            <div class="unknown-tags-list"></div>
            <div class="unknown-tags-actions">
                <button type="button" class="unknown-tags-skip">Skip</button>
                <button type="button" class="unknown-tags-save">Save & Continue</button>
            </div>
        </div>
    </div>

    <div id="unknown-status-modal" class="unknown-status-modal" aria-hidden="true">
        <div class="unknown-status-panel">
            <div class="unknown-status-header">
                <div class="unknown-status-title">Update Completion Status</div>
                <button type="button" class="unknown-status-close" aria-label="Close status update">‚úï</button>
            </div>
            <div class="unknown-status-subtitle">Update unfinished status entries.</div>
            <div class="unknown-status-list"></div>
            <div class="unknown-status-actions">
                <button type="button" class="unknown-status-skip">Skip</button>
                <button type="button" class="unknown-status-save">Save</button>
            </div>
        </div>
    </div>

    <div id="bridge-element" data-value="{{ selected_user_row_id }}" data-user="{{ selected_user }}"
        data-role="{{ role }}"></div>

    <div class="card-header">Configuration</div>
    <form method="POST" class="config-form" id="schedule-config">
        <div class="config-row">
            <label class="config-field" for="slot_type">
                <span>Time Slot Length:</span>
                <select name="slot_type" id="slot_type" onchange="this.form.submit()">
                    <option value="30" {% if slot_type=='30' %}selected{% endif %}>30 minutes</option>
                    <option value="60" {% if slot_type=='60' %}selected{% endif %}>1 hour</option>
                </select>
            </label>
            <label class="config-field" for="schedule_mode">
                <span>Schedule Mode:</span>
                <select name="schedule_mode" id="schedule_mode" onchange="this.form.submit()">
                    <option value="weekday" {% if schedule_mode=='weekday' %}selected{% endif %}>Weekday</option>
                    <option value="holiday" {% if schedule_mode=='holiday' %}selected{% endif %}>Holiday</option>
                    <option value="custom" {% if schedule_mode=='custom' %}selected{% endif %}>Custom</option>
                </select>
            </label>
        </div>
        <div class="config-row config-custom-row{% if schedule_mode != 'custom' %} config-hidden{% endif %}"
            data-custom="{{ schedule_mode }}">
            <label class="config-field" for="custom_start">
                <span>Custom Start:</span>
                <select id="custom_start" name="custom_start" class="config-time-select"
                    data-current="{{ custom_start }}" onchange="this.form.submit()">
                </select>
            </label>
            <label class="config-field" for="custom_end">
                <span>Custom End:</span>
                <select id="custom_end" name="custom_end" class="config-time-select" data-current="{{ custom_end }}"
                    onchange="this.form.submit()">
                </select>
            </label>
        </div>
    </form>
    <script src="{{ url_for('static', filename='js/todo.js') }}"></script>
</section>
{% endblock %}
