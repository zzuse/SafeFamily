{% extends "base.html" %}
{% block content %}

<nothingelse>
    <div class="top-bar">
        <div class="card-header mt-[20px]">{{ user_name }}'s Daily To-Do Planner {% if role == 'admin' %}(Admin){% endif
            %}</div>
        <div class="note">Note: To disable all rules, you must confirm that you have finished
            planned homework, and (<b>MATH</b>, <b>PIANO</b>, and <b>BOOKS</b> are
            mandatory
            every day)</div>
    </div>

    {% if role == 'admin' %}
    <form method="get" action="/todo">
        <label for="view_user">View User:</label>
        <select name="view_user" id="view_user" onchange="this.form.submit()">
            {% for u in users_list %}
            <option value="{{ u }}" {% if u==selected_user %}selected{% endif %}>{{ u }}</option>
            {% endfor %}
        </select>
    </form>
    {% endif %}

    <form method="POST">
        <label for="slot_type">Time Slot Length:</label>
        <select name="slot_type" id="slot_type" onchange="this.form.submit()">
            <option value="30" {% if slot_type=='30' %}selected{% endif %}>30 minutes</option>
            <option value="60" {% if slot_type=='60' %}selected{% endif %}>1 hour</option>
        </select>
    </form>

    <form method="POST">
        <label for="is_holiday">Today is a Holiday/School Break/Non-Instructional Day:</label>
        <select name="is_holiday" id="is_holiday" onchange="this.form.submit()">
            <option value="off" {% if is_holiday=='off' %}selected{% endif %}>OFF</option>
            <option value="on" {% if is_holiday=='on' %}selected{% endif %}>ON</option>
        </select>
    </form>

    <div class="today-section">
        <div class="card-header">{{ selected_user }}'s To-Do List Today</div>
        {% if today_tasks %}
        <form method="POST" action="/update_todo/{{ selected_user }}" class="task-update-form">
            <table class="table-modern">
                <tr>
                    <th>Time Slot</th>
                    <th>Task</th>
                    <th>Done</th>
                </tr>
                {% for todo_id, time_slot, task, completed in today_tasks %}
                <tr>
                    <td class="text-center">{{ time_slot }}</td>
                    <td>
                        <input type="hidden" name="todo_id" value="{{ todo_id }}">
                        <input type="text" name="task_{{ todo_id }}" value="{{ task }}"
                            class=" {% if completed %}done{% endif %}" style="width: 90%;" />
                    </td>
                    <td class="text-center">
                        <input type="checkbox" class="complete-checkbox" name="completed_{{ todo_id }}"
                            data-task-id="{{ todo_id }}" {% if completed %}checked{% endif %} />
                    </td>
                </tr>
                {% endfor %}
            </table>
            <div class="note">Note: Maintaining accurate records after completing each
                task.(means:modify)
            </div>
            <div class="btn-area">
                <button class="btn btn-success" type="submit" title="Save changes to all tasks">üíæ Modify
                    All</button>
            </div>
        </form>
        {% else %}
        <p class="message">No tasks saved for today.</p>
        {% endif %}
    </div>

    <div class="card-header mt-[30px]">Plan New To-Do List for {{ selected_user }}</div>

    <form method="POST" id="todoForm" class="planner-form">
        <input type="hidden" name="slot_type" value="{{ slot_type }}">
        <input type="hidden" name="is_holiday" value="{{ is_holiday }}">
        <table class="table-modern">
            <tr>
                <th>Time Slot</th>
                <th>Task</th>
            </tr>
            {% for slot in slots %}
            <tr>
                <td class="text-center">{{ slot }}</td>
                <td><input type="text" name="{{ slot }}" class="task-input"
                        placeholder="MainTask[SubProblem]/MainTask[SubProblem]" required style="width: 90%;">
                </td>
            </tr>
            {% endfor %}
        </table>
        <div class="btn-area">
            <button class="btn btn-success" type="submit" name="save_todo"
                title="This will overwrite the previous list.">üèÑüèª Delete Previous
                and
                Save
                New To-Do
                List</button>
        </div>
    </form>

    <script>
        document.getElementById("todoForm").addEventListener("submit", function (e) {
            const inputs = document.querySelectorAll(".task-input");
            const pattern = /^([^\[\]/]+\[[^\[\]]+\])(\s*\/\s*[^\[\]/]+\[[^\[\]]+\])*$/; // matches: main[sub]
            for (const input of inputs) {
                if (input.value.trim() !== "" && !pattern.test(input.value.trim())) {
                    e.preventDefault();
                    alert(`‚ùå Invalid format: "${input.value}". Use "main task[sub task]" format.`);
                    input.focus();
                    return;
                }
            }
        });

        document.querySelectorAll('.complete-checkbox').forEach(cb => {
            cb.addEventListener('change', function () {
                const taskId = this.dataset.taskId;
                const completed = this.checked;

                fetch("/todo/mark_done", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        id: taskId,
                        completed: completed
                    })
                })
                    .then(async r => {
                        let data = null;

                        // Check if response is JSON
                        const text = await r.text();
                        try {
                            data = JSON.parse(text);
                        } catch (e) {
                            console.error("Server did not return JSON:", text);
                            throw new Error("Invalid JSON response");
                        }
                        return data;
                    })
                    .then(data => {
                        if (data.success) {
                            location.reload();
                        } else {
                            alert("Update failed!");
                        }
                    })
                    .catch(err => {
                        console.error("AJAX error:", err);
                        alert("Error updating task");
                    });
            });
        });
    </script>

    {% if message %}
    <div class="message">{{ message }}</div>
    {% endif %}

    <div class="btn-area">
        {% if show_disable_button %}
        <form action="/exec_rules/{{ selected_user_row_id }}"
            onsubmit="return confirm('Are you sure you brush toilet, take out the garbage, and wash the dishes?');"
            method="POST">
            <button class="btn btn-failure" type="submit" title="Disable all rules after mandatory cleanup">üõë
                Disable
                All Rules</button>
        </form>
        {% else %}
        <p class="note" style="color:#7f8c8d; background-color: transparent;">Not proper time to disable rules
            (button
            available between 4 PM and 6 PM)</p>
        {% endif %}
    </div>

    <div class="bottom-bar">
        <p style="margin: 0;">Daily To-Do Planner by zzuse</p>
    </div>
</nothingelse>
{% endblock %}