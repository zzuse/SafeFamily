# Rate limiting
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=5r/s;

# ----------------------------------------------------
# 1. INTERNAL HTTP SERVER (No SSL Termination)
# ----------------------------------------------------
server {
    # Listen only on the specific internal IP and port
    listen 10.0.0.30:8080;
    server_name zzuse.duckdns.org; # Matches any domain/IP requested

    # Define the specific location for your internal route
    location /logs {
        # Route directly to your Gunicorn/Flask instance via HTTP
        proxy_pass http://127.0.0.1:8000;

        # Forward minimal headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;

        # Disable caching and other security measures if required for the hook
        proxy_buffering off;
    }

    # Optional: Deny all other internal traffic on this port
    location / {
        return 404; # Not found for all other routes on this port
    }
}

# ----------------------------------------------------
# 2. EXISTING PUBLIC HTTPS SERVER (SSL Termination)
# ----------------------------------------------------
# This block handles all standard traffic (HTTPS on port 443)
server {
	# Listen for standard HTTP traffic
	listen 80; 
	server_name zzuse.duckdns.org;
	# Redirect all HTTP traffic to HTTPS
	return 301 https://$server_name$request_uri; 
}

server {
	# Listen for HTTPS traffic (port 443)
	listen 443 ssl; 
	server_name zzuse.duckdns.org;
	client_max_body_size 50m;

	# SSL Configuration (SSL Termination)
	ssl_certificate /etc/ssl/certs/safefamily.crt;
	ssl_certificate_key /etc/ssl/private/safefamily.key;

	# Optional security headers (recommended)
	ssl_protocols TLSv1.2 TLSv1.3;
	ssl_ciphers HIGH:!aNULL:!MD5; 

	# Route requests to Gunicorn (Internal Proxy)
	location / {
		limit_req zone=api_limit burst=10 nodelay;
		# Proxy traffic internally to Gunicorn via HTTP
		proxy_pass http://127.0.0.1:8000; 

		# Forward required headers
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		# Crucially, let Flask/Gunicorn know the original request was HTTPS
		proxy_set_header X-Forwarded-Proto https; 
	}
}
